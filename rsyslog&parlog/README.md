# Руководство 

## 1. Регистрация событий входа и выхода субъектов доступа в систему, событий запуска и завершения работы системы (перезагрузка, остановка)

Событий входа пользователей в систему регистрируются в журнале **rsyslog** */var/log/auth.log*.

1) События входа в систему, используя граф. оболочку fly-dm
   
   Успешные:
   
   ```
   cat /var/log/auth.log | grep 'pam_unix(fly-dm:session):'
   ```  
   
   ![show sessions](https://user-images.githubusercontent.com/40645030/119470253-d3993a80-bd50-11eb-9669-a66e335919b8.png)

   Неуспешные:
   
   ```
   $ cat /var/log/auth.log | grep '(fly-dm:auth):'
   ```
   
   Здесь видим регистрацию двух возмодных событий: введен неизвестный (незарегистрированный) логин или неверный пароль.
   В зеленым прямоугольнике - события попытки входа под неизвестным системе логином *asmin-1*.
   В розов прямоугольнике - событие попытки ввода неверное пароля для пользователя *guest*.
   
   ![fly-dm auth failure](https://user-images.githubusercontent.com/40645030/119470270-da27b200-bd50-11eb-9b2d-06490851a4f9.png)
   
   
2) Неверный пароль при попытке разблокировать рабочего стола fly-wm
   
   ```
   $ cat /var/log/auth.log | grep '(fly-wm:auth):'
   ```
   
   ![fly-wm auth failure](https://user-images.githubusercontent.com/40645030/119470542-1e1ab700-bd51-11eb-8604-6fa178eb65a1.png)

3) Подключения через ssh
   
   Успешные:
   
   ```
   $ cat /var/log/auth.log | grep '(sshd:session):'
   ```
   
   ![ssh session](https://user-images.githubusercontent.com/40645030/119471644-24f5f980-bd52-11eb-8f41-a0463d8f1222.png)
   
   Неуспешные:
   
   ```
   $ cat /var/log/auth.log | grep 'sshd:auth):'
   ```
   
   На этом изображении видно, что было предпринято 3 неуспешных попытки вход для пользователя *astra* с адреса *192.168.190.125*. Не удалось пройти аутентификацию, 
   так как пользователь *astra*  не зарегистрирован в системе.
   
   ![ssh auth fail](https://user-images.githubusercontent.com/40645030/119471970-78684780-bd52-11eb-9db3-d13b28315cf7.png)

5) Выполнение команд от имени другог пользователя (su)
6) Выволнение sudo команд

## 2. Регистрация событий запуска и завершения программ

Необходимо установить правила регистрации событий *Запуск программ (exec)* Политки аудита подсистемы PARSEC.

Перейти "Панель управления" -> "Безопасность" -> "Политика безопасности" -> "Аудит", в вкладке "По умолчанию" установить следующие правила:

![политика аудита 1](https://user-images.githubusercontent.com/40645030/119472777-34c20d80-bd53-11eb-9ccd-3873f8e88d29.png)

События "Запуск программ" регистрируются в журнале */var/log/parsec/kernel.mlog*.

Просмотр всех запущенных программ за последний определенный час (c 12 по 13 25.05.2021): 

```
$ sudo kernlog -e exec -e open -t 21052512  -o "%t %N '%c' <PID=%p UID=%u RES=%r> %A"
```

![kernlog запуск программ](https://user-images.githubusercontent.com/40645030/119485493-cfc0e480-bd5f-11eb-9fc4-64da9868002a.png)

Просмотр запуска программ из пакета *LibreOffice*:

```
$ sudo kernlog -e exec -e open -o "%t %N '%c' <PID=%p UID=%u RES=%r> %A" | grep soffice 
```

![kernlog запуск программ Libreoffice](https://user-images.githubusercontent.com/40645030/119485512-d8b1b600-bd5f-11eb-818e-b60822812e79.png)

## 3. Регистрация событий доступа к файлам

Установка правил аудита доступа к отдельным файлам или каталогам производится с помощью команды **setfaud**. 

#### Setfaud
> устанавливает списки правил протоколирования на файлы. 
  
Правила протоколирования задаются в виде:
 - [u:<пользователь>:<флаги протоколирования>]
 - [,g:<группа>:<флаги протоколирования>]
 - [,o:<флаги протоколирования>], ...  
  
Где  <пользователь>  и  <группа>  -- символические или численные идентификаторы пользователя и группы.  
*u:* -- означает правило для пользователя, *g:* -- для группы, *o:* -- для остальных.

Список событий аудита:

```
   o  open     -- открытие
   x  exec     -- запуск
   u  delete   -- удаление
   d  chmod    -- изменение прав доступа
   n  chown    -- изменение владельца
   a  audit    -- изменение правил протоколирования
   r  acl      -- управление списком прав доступа
   m  mac      -- изменение мандатных атрибутов
   c  create   -- создание
   y  modify   -- изменение
```


Пример добавления правила аудита успешного события open, неуспешного события chmod для пользователя ttt на файл /tmp/lll: 

```
$ sudo setfaud -m u:ttt:+open:+chmod /tmp/lll 
```

Пример добавления правила аудита события open для файла /tmp/lll пользователям, для которых флаги протоколирования не заданы явно (other): 

```
$ sudo setfaud -m o:+open /tmp/lll 
```

Сбросить все флаги протоколирования для файла /tmp/lll: 

```
$ sudo setfaud -X /tmp/lll
```

Пример добавления правила аудита успешных и неуспешных событий open и exec на каталог и все файлы в нём (на всех уровнях вложенности):

```
$ sudo setfaud -Rm o:+open+exec:+open+exec ./test_folder  
```
