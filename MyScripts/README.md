# Регистрация событий в Astra Linux SE 1.6

## 1. Регистрация событий НСД

Для автоматического учета неуспешных попыток авторизации пользователей был разработан bash-скрипт, собирающих информацию о событиях из журналов
**/var/log/auth.log** и **/var/log/parsec/kernel.mlog**.

### Регистрируемые события 

1) Попытка выполнить команду, требующую повышенных привилегий, пользователем без sudo прав
   
   Используется следующий фильтр:
   
   ```
   awk '/${time_filter}/ {out=1} /user NOT in sudoers/ {if (out) print}' /var/log/auth.log
   ```
   
   Переменная $time_filter задает строку для поиска и фильтрации подходящих логов по *дате*. О формировании и назначении этой переменной поговорим чуть 
   позже **вот в этом** разделе.
   
2) Неверный пароль при попытке вызова команды с sudo
   
   Используется следующий фильтр:
   
   ```
   awk '/${time_filter}/ {out=1} /sudo:/ && /: 3 incorrect password attempts ;/  {if (out) print}' /var/log/auth.log
   ```
   
3) Ввод недействительного логина при попытке входа в систему (fly-dm)
   
   Фильтр: 
   
   ```
   awk '/${time_filter}/ {out=1} /fly-dm:auth/ && /Unknown user/ {if (out) print}' /var/log/auth.log
   ```

4) Ввод неверного пароля при попытке входа в систему (аly-dm)
   
   Фильтр:
   
   ```
   awk '/${time_filter}/ {out=1} /fly-dm:auth/ && /authentication failure/ && /\<user=/  {if (out) print}' /var/log/auth.log
   ``` 

5) Неверный пароль при попытке разблокировать рабочий стол fly-wm
   
   ```
   $ awk '/${time_filter}/ {out=1} /(fly-wm:auth):/ {if (out) print}' /var/log/auth.log
   ``` 
   
6) Вызов под su, ввод недействительного логина
   
   Фильтр:
   
   ```
   awk '/${time_filter}/ {out=1} /su/ && /No passwd entry for user/ {if (out) print}' /var/log/auth.log
   ```
   
7) Вызов под su, ввод неверного пароля
   
   фильтр:
   
   ```
   awk '/${time_filter}/ {out=1} /su/ && /su:auth/ && /authentication failure/ {if (out) print}' /var/log/auth.log
   ```

8) Вход по ssh, ввод неверного пароля
   
   Фильтр:
   
   ```
   awk '/${time_filter}/ {out=1} /sshd/ && /sshd:auth/ && /authentication failure/ {if (out) print}' /var/log/auth.log
   ```
   
Срипт сохраняет собранные данные в отдельнй файл ***/home/$user/log/AUTH_${date}.log***. 
Где **$user** - имя пользователя, от имени которого запущен скрипт, **$date** - значение времени с точностью до секунд, в которое сформирован отчет.

Перед началом работы скрипта проверяет существование каталогая ***/home/$user/***.

### Автоматический запуск

В качестве настройки автоматического выполнения проверки добавили запуск скрипта каждый час в планировщике **crontab**.

```
$ sudo crontab -u $(whoami) -e
```

В появившемся файле добавить следующую строку в конец файла :

```
05 * * * * /bin/bash /home/user/audit_scripts/task_5.sh
```

Таким образом, указанный скрипт будет запущен каждый час в 05 минут (при условии, что ОС загружена).

### Фильтр событий по времени

Чтобы создаваемые скриптом файлы не дублировали содержимое, добавим фильтрацию событий по времени регистрации.

Идея заключается в следующем. Сначал в журнале **/var/log/syslog** проверяем время, когда последний раз был запущена задача **CRON** с запуском нашего скрипта
и сохраняем полученное значение в переменной **$time_filter**.

```
# в /var/log/syslog проверяем время последнего вызова скрипта (через CRON)
date=$(cat /var/log/syslog | awk '/CRON/ && /task_5.sh/' | tail -n2 | head -n1 | awk '{printf("%s %s %s", $1, $2, $3)}')
if [[ ! -z $date ]]
then 
	# Формирование фильтра по времени для поиска в журнале /var/log/auth.log
	time_filter="${date}" 
```

Далее при поиске соотвествующих событий в каждую команду добавляется фильтр со строкой со значением времени регистрации (из переменоой ), начиная с котрого нужно проверять события. 
